<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文本差异对比 - AI Chat Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tool.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .diff-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
        }
        
        .diff-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .diff-panel textarea {
            flex: 1;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            resize: none;
        }
        
        .diff-result {
            flex: 1;
            overflow: auto;
            padding: 15px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .diff-result .added {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        
        .diff-result .removed {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        
        .diff-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 15px 0;
        }
        
        .file-upload-section {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .file-upload-section input[type="file"] {
            display: none;
        }
        
        .file-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .file-upload-btn:hover {
            background: var(--bg-hover);
        }
        
        .file-name {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-comments"></i>
                    <span>AI Chat</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <a href="/tools" class="nav-item">
                    <i class="fas fa-tools"></i>
                    <span>工具列表</span>
                </a>
                <a href="/" class="nav-item">
                    <i class="fas fa-arrow-left"></i>
                    <span>返回聊天</span>
                </a>
                <div class="nav-item active">
                    <i class="fas fa-exchange-alt"></i>
                    <span>文本差异对比</span>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-info" id="userInfo">
                    <i class="fas fa-user-circle"></i>
                    <span id="username">加载中...</span>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>文本差异对比工具</h1>
            </header>

            <div class="tool-container">
                <div class="tool-workspace">
                    <div class="diff-container">
                        <div class="diff-panel">
                            <div class="section-header">
                                <label><i class="fas fa-file-alt"></i> 原始文本 (左)</label>
                                <div class="action-buttons">
                                    <div class="file-upload-section">
                                        <label class="file-upload-btn">
                                            <i class="fas fa-upload"></i> 上传文件
                                            <input type="file" id="fileLeft" accept=".txt,.md,.json,.js,.py,.html,.css,.xml,.csv,.log" onchange="loadFile(this, 'textLeft')">
                                        </label>
                                        <span class="file-name" id="fileNameLeft"></span>
                                    </div>
                                    <button class="btn btn-small" onclick="clearText('textLeft')">
                                        <i class="fas fa-trash-alt"></i> 清空
                                    </button>
                                    <button class="btn btn-small" onclick="pasteText('textLeft')">
                                        <i class="fas fa-paste"></i> 粘贴
                                    </button>
                                </div>
                            </div>
                            <textarea id="textLeft" placeholder="请输入第一段文本或上传文件..."></textarea>
                        </div>

                        <div class="diff-panel">
                            <div class="section-header">
                                <label><i class="fas fa-file-alt"></i> 新文本 (右)</label>
                                <div class="action-buttons">
                                    <div class="file-upload-section">
                                        <label class="file-upload-btn">
                                            <i class="fas fa-upload"></i> 上传文件
                                            <input type="file" id="fileRight" accept=".txt,.md,.json,.js,.py,.html,.css,.xml,.csv,.log" onchange="loadFile(this, 'textRight')">
                                        </label>
                                        <span class="file-name" id="fileNameRight"></span>
                                    </div>
                                    <button class="btn btn-small" onclick="clearText('textRight')">
                                        <i class="fas fa-trash-alt"></i> 清空
                                    </button>
                                    <button class="btn btn-small" onclick="pasteText('textRight')">
                                        <i class="fas fa-paste"></i> 粘贴
                                    </button>
                                </div>
                            </div>
                            <textarea id="textRight" placeholder="请输入第二段文本或上传文件..."></textarea>
                        </div>
                    </div>

                    <div class="diff-controls">
                        <button class="btn btn-primary" onclick="compareDiff()">
                            <i class="fas fa-sync-alt"></i> 对比差异
                        </button>
                        <button class="btn" onclick="swapTexts()">
                            <i class="fas fa-exchange-alt"></i> 交换位置
                        </button>
                        <button class="btn" onclick="copyResult()">
                            <i class="fas fa-copy"></i> 复制结果
                        </button>
                    </div>

                    <div class="output-section">
                        <div class="section-header">
                            <label><i class="fas fa-check-circle"></i> 差异结果</label>
                            <div class="action-buttons">
                                <button class="btn btn-small" onclick="clearResult()">
                                    <i class="fas fa-trash-alt"></i> 清空
                                </button>
                            </div>
                        </div>
                        <div id="diffResult" class="diff-result">
                            <span style="color: var(--text-secondary);">点击"对比差异"按钮查看差异结果...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.2.0/diff.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        let diffResultText = '';

        function loadFile(input, textareaId) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(textareaId).value = e.target.result;
                
                const fileNameSpan = textareaId === 'textLeft' ? 'fileNameLeft' : 'fileNameRight';
                document.getElementById(fileNameSpan).textContent = file.name;
            };
            reader.onerror = function() {
                alert('文件读取失败');
            };
            reader.readAsText(file);
        }

        function clearText(textareaId) {
            document.getElementById(textareaId).value = '';
            if (textareaId === 'textLeft') {
                document.getElementById('fileNameLeft').textContent = '';
            } else {
                document.getElementById('fileNameRight').textContent = '';
            }
        }

        async function pasteText(textareaId) {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById(textareaId).value = text;
            } catch (e) {
                alert('无法访问剪贴板');
            }
        }

        function compareDiff() {
            const textLeft = document.getElementById('textLeft').value;
            const textRight = document.getElementById('textRight').value;
            const resultDiv = document.getElementById('diffResult');

            if (!textLeft && !textRight) {
                resultDiv.innerHTML = '<span style="color: var(--text-secondary);">请输入要对比的文本...</span>';
                return;
            }

            const diff = Diff.diffLines(textLeft, textRight);
            let html = '';
            diffResultText = '';

            diff.forEach((part) => {
                const colorClass = part.added ? 'added' : part.removed ? 'removed' : '';
                const prefix = part.added ? '+ ' : part.removed ? '- ' : '  ';
                const escapedText = escapeHtml(part.value);
                
                if (colorClass) {
                    html += `<span class="${colorClass}">${escapedText}</span>`;
                } else {
                    html += escapedText;
                }
                diffResultText += prefix + part.value;
            });

            resultDiv.innerHTML = html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function swapTexts() {
            const leftText = document.getElementById('textLeft').value;
            const rightText = document.getElementById('textRight').value;
            
            document.getElementById('textLeft').value = rightText;
            document.getElementById('textRight').value = leftText;

            const leftFileName = document.getElementById('fileNameLeft').textContent;
            const rightFileName = document.getElementById('fileNameRight').textContent;
            
            document.getElementById('fileNameLeft').textContent = rightFileName;
            document.getElementById('fileNameRight').textContent = leftFileName;
        }

        async function copyResult() {
            if (!diffResultText) {
                alert('没有可复制的内容');
                return;
            }
            try {
                await navigator.clipboard.writeText(diffResultText);
                alert('已复制到剪贴板');
            } catch (e) {
                alert('复制失败');
            }
        }

        function clearResult() {
            document.getElementById('diffResult').innerHTML = '<span style="color: var(--text-secondary);">点击"对比差异"按钮查看差异结果...</span>';
            diffResultText = '';
        }
    </script>
</body>
</html>
